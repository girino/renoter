name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  build-binaries:
    name: Build Binaries
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          # Linux architectures
          - goos: linux
            goarch: amd64
            output: renoter-client-linux-amd64
          - goos: linux
            goarch: arm64
            output: renoter-client-linux-arm64
          - goos: linux
            goarch: arm
            output: renoter-client-linux-armv7
          # macOS architectures
          - goos: darwin
            goarch: amd64
            output: renoter-client-darwin-amd64
          - goos: darwin
            goarch: arm64
            output: renoter-client-darwin-arm64
          # Windows architectures
          - goos: windows
            goarch: amd64
            output: renoter-client-windows-amd64.exe
          - goos: windows
            goarch: arm64
            output: renoter-client-windows-arm64.exe
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Build client binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -ldflags '-extldflags "-static"' -o ${{ matrix.output }} ./cmd/client

      - name: Build server binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          if [[ "${{ matrix.goos }}" == "windows" ]]; then
            output="renoter-server-${{ matrix.goos }}-${{ matrix.goarch }}.exe"
          else
            output="renoter-server-${{ matrix.goos }}-${{ matrix.goarch }}"
          fi
          go build -ldflags '-extldflags "-static"' -o $output ./cmd/server

      - name: Upload client binary
        uses: actions/upload-artifact@v4
        with:
          name: client-${{ matrix.goos }}-${{ matrix.goarch }}
          path: ${{ matrix.output }}
          retention-days: 30

      - name: Upload server binary
        uses: actions/upload-artifact@v4
        with:
          name: server-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            renoter-server-${{ matrix.goos }}-${{ matrix.goarch }}*
          retention-days: 30

  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: linux/amd64,linux/arm64

      - name: Extract version and tag info
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          
          # Determine if pre-release
          if [[ "$TAG" =~ -(beta|alpha|rc[0-9]+)$ ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi
          
          # Docker tag (remove v prefix)
          DOCKER_TAG=${TAG#v}
          echo "docker_tag=$DOCKER_TAG" >> $GITHUB_OUTPUT
          
          # Short tag for stable releases (latest for non-pre-releases)
          if [[ "$TAG" =~ -(beta|alpha|rc[0-9]+)$ ]]; then
            echo "docker_tag_latest=" >> $GITHUB_OUTPUT
          else
            echo "docker_tag_latest=latest" >> $GITHUB_OUTPUT
          fi

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push client image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.client
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/renoter-client:${{ steps.version.outputs.docker_tag }}
            ${{ steps.version.outputs.docker_tag_latest != '' && format('ghcr.io/{0}/renoter-client:{1}', github.repository, steps.version.outputs.docker_tag_latest) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push server image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.server
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/renoter-server:${{ steps.version.outputs.docker_tag }}
            ${{ steps.version.outputs.docker_tag_latest != '' && format('ghcr.io/{0}/renoter-server:{1}', github.repository, steps.version.outputs.docker_tag_latest) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-binaries, build-docker]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Extract version info
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=${TAG#v}" >> $GITHUB_OUTPUT
          
          # Determine if pre-release
          if [[ "$TAG" =~ -(beta|alpha|rc[0-9]+)$ ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          
          # Artifacts are downloaded into subdirectories named after the artifact name
          # Find all client binaries (they're in directories like client-linux-amd64/)
          find . -type d -name "client-*" -o -type f -name "client-*" | while read item; do
            if [ -d "$item" ]; then
              # It's a directory, find files inside it
              find "$item" -type f -exec mv {} release-assets/ \;
            elif [ -f "$item" ]; then
              # It's a file in root, move it
              mv "$item" release-assets/
            fi
          done
          
          # Find all server binaries (they're in directories like server-linux-amd64/)
          find . -type d -name "server-*" -o -type f -name "server-*" | while read item; do
            if [ -d "$item" ]; then
              # It's a directory, find files inside it
              find "$item" -type f -exec mv {} release-assets/ \;
            elif [ -f "$item" ]; then
              # It's a file in root, move it
              mv "$item" release-assets/
            fi
          done
          
          # Create checksums (only if files exist)
          cd release-assets
          if [ "$(ls -A . 2>/dev/null)" ]; then
            sha256sum * > checksums.txt
          else
            echo "Error: No binaries found in release-assets directory"
            echo "Contents of current directory:"
            ls -la
            echo "Artifacts downloaded:"
            find . -type f -o -type d | head -20
            exit 1
          fi

      - name: Generate release notes
        id: release_notes
        run: |
          # Read the template and substitute placeholders
          sed -e "s|__REPO__|${{ github.repository }}|g" \
              -e "s|__TAG__|${{ steps.version.outputs.tag }}|g" \
              -e "s|__VERSION__|${{ steps.version.outputs.version }}|g" \
              .github/release-template.md > release-notes.md
          cat release-notes.md >> $GITHUB_STEP_SUMMARY

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.tag }}
          body_path: release-notes.md
          draft: false
          prerelease: ${{ steps.version.outputs.prerelease }}
          files: |
            release-assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

